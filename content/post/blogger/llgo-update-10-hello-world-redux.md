+++
title = "llgo update #10: \"hello, world!\" redux"
date = 2012-11-25T14:28:00Z
updated = 2012-11-26T11:53:31Z
tags = ["go", "llgo", "llvm"]
blogimport = true 
aliases = [

  "/2012/11/llgo-update-10-hello-world-redux.html",

]
[author]
	name = "Andrew Wilkins"
	uri = "https://plus.google.com/102738380796586573408"
+++

It's about time for another progress update on llgo. I've made decent progress recently, so let's go through what's new.<br /><br /><h4>Highlights</h4>I've been refactoring bits of code and fixing bugs aplenty, so there is a mass of noise in the git commits. In terms of new function, the news is that we now have:<br /><br /><ul><li>Type switches.</li><li>Type assertions.</li><li>Labeled statements; goto, labeled break and continue.</li><li>The <a href="https://github.com/axw/llgo/tree/master/cmd/llgo-dist">llgo-dist</a> command; more on this below.</li><li>String conversions: to/from byte slices; from rune/int.</li><li>String range. I'm sure <a href="https://github.com/axw/llgo/blob/master/pkg/runtime/strings.go#L77">the implementation</a>&nbsp;could be improved.</li><li>Implemented <a href="https://github.com/axw/llgo/blob/master/pkg/sync/atomic/atomic.ll">sync/atomic</a> using LLVM atomic operations intrinsics.</li><li>Various changes to enable linking multiple packages (e.g. exported symbols are now prefixed with their package path).</li><li>Additional support for floats (<a href="https://github.com/axw/llgo/pull/11">thanks to spate</a>); partial support for complex numbers.</li><li>"...args" calls to variadic functions (including slice append).</li><li>A self-contained runtime package. I have cloned (and slightly modified in some cases) the Go portion of the runtime package from gc, and combined it with the runtime code I had already written for llgo.</li><li><a href="https://github.com/axw/llgo/blob/master/pkg/math/math.ll">Bridge code for the math package,</a> which mostly just redirects the exported functions to the internal, pure-Go implementations.</li><li>System calls (<a href="https://github.com/axw/llgo/blob/master/pkg/syscall/syscall_linux_amd64.ll">Linux/AMD64</a> only so far).</li><li>Closures; more below.</li></ul><div><br /></div><h4>llgo-dist</h4><div>I have begun implementing a command that takes care of building llgo, its runtime, and in the future any other tools that might be considered part of llgo (e.g. an in-development linker). This tool will set up the cgo flags given the path to an "llvm-config" program, and build gollvm.<br /><br /></div><h4><i>reflect</i>, <i>fmt</i>, oh my!</h4><br />Last week, <a href="https://plus.google.com/u/0/102738380796586573408/posts/LDYxBXHXmHN">I mentioned on Google+</a>&nbsp;that I managed to get the <a href="http://golang.org/pkg/reflect">reflect</a>&nbsp;package working. At least enough of it to get the <a href="http://golang.org/pkg/fmt/">fmt</a>&nbsp;package to work. At least enough of the fmt package to get fmt.Println("Hello, world!") to work...&nbsp;Yep, the holy grail of programming examples now compiles, links, and runs, using llgo. This demonstrates the following things work:<br /><br /><ol><li>Compilation of the following packages:&nbsp;errors, io, math, os, reflect, runtime, strconv, sync, sync/atomic, syscall, time, unicode/utf8, unsafe.</li><li>Package imports (still using the gcimporter from exp/types.)</li><li>Linking multiple compiled packages using llvm-link.</li><li>Interfaces and reflection (fmt.Println uses reflection to determine the underlying type).</li><li>System calls (fmt.Println will eventually issue a system call to write to the stdout file).</li></ol><br /><h4>Closures</h4>Yes indeed, we now have closures. <a href="https://github.com/axw/llgo/blob/master/literals.go#L70">The code</a> is pretty hackish, so I expect it's not very solid. I have implemented them using LLVM's trampoline intrinsics. Essentially you provide LLVM with a function that takes N parameters, give it a block of (executable) memory and an argument to bind, and it fills in the block with function code for a function with N-1 parameters (the Nth one being bound).<br /><br />Unfortunately I have found that the closures are not playing nicely with lli/JIT, which means the closure unit test I have written fails. If I compile it with llc/gcc, though, it works just fine. So either I've done something subtly stupid, or the JIT is clobbering something it shouldn't. As far as I got with debugging was finding that the bound argument value is wrong when the function is entered.<br /><br />I expect I'll probably replace this implementation for a couple of reasons:<br /><br /><ul><li>Portability: I'd rather avoid platform-specific code like this.&nbsp;For one thing, the <a href="http://www.chromium.org/nativeclient/pnacl/bitcode-abi">PNaCl ABI</a>&nbsp;calls out trampoline intrinsics as being unsupported.</li><li>Testability: I should investigate the problems I observed with lli/JIT further, and I'm loath to change implementation to support tests, it is a real problem. I rely heavily on tests to make sure I haven't broken anything.</li></ul><div>Until I find out that using trampolines has a marked benefit to performance in real programs, I intend to replace the current implementation with one that uses a pair of pointers for functions. The bound argument will stored in one pointer, and the function pointer in another. This has implications for all function calls, though it should be simple to achieve good performance in most cases.<br /><br /></div><h4>What's next?</h4><div>Haven't figured this one out yet. I have been meaning to play more with PNaCl, so I might take some time now to do that. I expect I'll be slowing down development considerably early 2013, as (a) we're knocking down our place and rebuilding, and (b) my second child is on the way. I hope to have llgo in a better state for contributions by then, so others can pick up the slack.</div><div><br /></div><div>I expect in the near future I'll start playing with clang/cgo integration, as I start playing with PNaCl. I'll write back when I have something to demonstrate.</div><div><br /></div><div>Until then.</div>
