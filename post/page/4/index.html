
<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Posts | awilkins.id.au</title>
<link rel="stylesheet" href="https://awilkins.id.au//css/style.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/github.min.css">


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
	
	<a class="nav-item" href="https://awilkins.id.au/">
	<h1 class="title is-4" style="color: #666666; font-weight: bold">
	a<span style="color:#4a83d4; font-weight: bold">wilkins</span>.id.<span style="color:#4a83d4; font-weight: bold">au</span>
	</h1>
	</a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/axw">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/yayxw">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
          <a class="level-item" href="/index.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/blogger/inline-python-macros-in-c/">Inline Python macros in C</a></h1>
      <div class="content">
        <p>I had a bit of time today to do some more work on that which is soon to be called something other than csnake. I&rsquo;ve added a couple of features:<br /><br /><ul><li>You can now define custom pragmas, providing a Python handler function. Unfortunately Boost Wave, which csnake uses for preprocessing, only provides callbacks for pragmas that start with &ldquo;#pragma wave&rdquo;.</li><li>Built-in pragmas and macros to support defining Python macros inline in C/C++ code.</li><li>A <strong>main</strong> program in the csnake package. So you can now do &ldquo;python3.2 -m csnake <source file=""></source>&rdquo;, which will print out the preprocessed source.</li></ul><div>So for example, you can do something like as follows, entirely in one C++ file:</div><br /><div><pre class="brush:c++">// factorial macro.<br />py_def(factorial(n))<br />    import math<br />    f = math.factorial(int(str(n)))<br />    return [Token(T_INTLIT, f)]<br />py_end<br /><br />int main()<br />{<br />    std::cout &lt;&lt; factorial(3) &lt;&lt; std::endl;<br />    return 0;<br />}<br /></pre></div><div><br />This works as follows: <i>py_def</i> and <i>py_end</i>&nbsp;are macros, which in turn use the _Pragma operator with built-in pragmas. Those pragmas are handled by csnake, and signal to collect the tokens in between. When the py_end macro is reached, the tokens are concatenated and a Python function macro is born.<br /><br />I&rsquo;m intending to do additonal &ldquo;Python blocks&rdquo;, including at least a <i>py_for</i>&nbsp;block, which will replicate the tokens within the block for each iteration of a loop.<br /><br />There&rsquo;s one big problem with the <i>py_def</i>&nbsp;support at the moment, which is that the tokens go through the normal macro replacement procedure. I think I&rsquo;ll have a fix for that soon.</div></p>

      </div>
      <h2 class="subtitle is-6">
      Posted June 18, 2011.
      
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/blogger/name-clash/">Name clash</a></h1>
      <div class="content">
        <p>Rats, looks like I didn&rsquo;t do enough homework on the name &ldquo;csnake&rdquo;. Turns out there&rsquo;s another Python-based project called CSnake:&nbsp;<a href="https://github.com/csnake-org/CSnake/">https://github.com/csnake-org/CSnake/</a>. Incidentally - and not that it matters much - I had the name picked out before that project was released. Now I need to think up another puntastic name.</p>

      </div>
      <h2 class="subtitle is-6">
      Posted June 15, 2011.
      
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/blogger/c-preprocessor-macros-in-python/">C-Preprocessor Macros in Python</a></h1>
      <div class="content">
        <p>TL;DR: I&rsquo;ve started a new project, <a href="https://github.com/axw/csnake">csnake</a>,&nbsp;which allows you to write your C preprocessor macros in Python.<br /><br />Long version ahead&hellip;<br /><br /><span class="Apple-style-span" style="font-size: large;"><b>You want to do what now?</b></span><br /><br />I had this silly idea a couple of years ago, to create a C preprocessor in which macros can be defined in Python. This was borne out of me getting sick of hacking build scripts to generate code from data, but pursued more for fun.<br /><br />I started playing around with <a href="http://www.boost.org/doc/libs/1_46_1/libs/wave/index.html">Boost Wave</a>, which is a <i>&ldquo;Standards conformant, and highly configurable implementation of the mandated C99/C++ preprocessor functionality packed behind an easy to use iterator interface&rdquo;</i>. With a little skulduggery coding, I managed to define macros as C++ callable objects taking and returning tokens. Then it was a simple matter of adding a Python API.<br /><br /><br /><b><span class="Apple-style-span" style="font-size: large;">The Result</span></b><br /><br />What we end up with is a Python API that looks something like this:<br /><br /><pre class="brush:py">import sys<br />from _preprocessor import *<br />def factorial(n):<br />    import math<br />    return [Token(T_INTLIT, math.factorial(int(str(n))))]<br /><br />p = Preprocessor(&ldquo;test.cpp&rdquo;)<br />p.define(factorial)<br />for t in p.preprocess():<br />    sys.stdout.write(str(t))<br />sys.stdout.write(&rdquo;\n&rdquo;)<br /></pre><br />Which will take&hellip;<br /><br /><pre class="brush:cpp">int main(){return factorial(3);}<br /></pre><br />And give you&hellip;<br /><br /><pre class="brush:cpp">int main(){return 6;}<br /></pre><br />If it&rsquo;s not immediately clear, it will translate &ldquo;factorial(<int literal="">)&rdquo; into an integer literal of the factorial of the input token. This isn&rsquo;t a very interesting example, so if you can imagine a useful application, let me know ;)</int><br /><br />The above script will work with the current code, using Python 3.2, compiling with GCC. If you&rsquo;d like to play with it, grab the code from the <a href="https://github.com/axw/csnake">csnake github repository</a>. Once you&rsquo;ve got it, run &ldquo;python3.2 setup.py build&rdquo;. Currently there is just an extension module (&ldquo;csnake._preprocessor&rdquo;), so set your PYTHONPATH to the build directory and play with that directly.<br /><br />I have chosen to make csnake Python 3.2+ only, for a couple of major reasons:<br /><br /><ul><li>All the cool kids are doing it: it&rsquo;s the way of the future. But seriously, Python 3.x needs more projects to become more mainstream.</li><li>Python 3.2 implements&nbsp;<a href="http://www.python.org/dev/peps/pep-0384/">PEP 384</a>, which allows extension modules to be used across Python versions. <i>Finally.</i>&nbsp;I always hated that I had to recompile for each version.</li></ul><div>&hellip; and one very selfish (but minor) reason: I wanted to modernise my Python knowledge. I&rsquo;ve been ignoring Python 3.x for far too long.</div><div><br /></div><br /><br /><span class="Apple-style-span" style="font-size: large;"><b>The Road Ahead</b></span><br /><br />What I&rsquo;ve done so far is very far from complete, and not immediately useful. It may never be very useful. But if it is to be, it would require at least:<br /><ul><li>A way of detecting (or at least configuring) pre-defined macros and include paths for a target compiler/preprocessor. A standalone C preprocessor isn&rsquo;t worth much. It needs to act like or delegate to a real preprocessor, such as GCC.</li><li>A #pragma to define Python macros in source, or perhaps if I&rsquo;m feeling adventurous, something like #pydefine.</li><li>A simple, documented Python API.</li><li>A simple command line interface with the look and feel of a standard C preprocessor.</li><li>Some unit tests.</li></ul><div>I hope to add these in the near future. I&rsquo;ve had code working for the first two points, and the remaining points are relatively simple. I will post again when I have made some significant progress.</div></p>

      </div>
      <h2 class="subtitle is-6">
      Posted June 11, 2011.
      
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/blogger/pushy-0.5-released/">Pushy 0.5 Released</a></h1>
      <div class="content">
        <p>After just a few short months since the 0.4 release, I am pleased to announce <a href="http://awilkins.id.au/pushy">Pushy </a>0.5. As usual, this release is mostly bug fixes, with a couple of features to make life easier. Instructions on downloading and installing can be found here:<br />&nbsp; &nbsp;&nbsp;<a href="http://awilkins.id.au/pushy/install.php">http://awilkins.id.au/pushy/install.php</a><br /><br />On top of standard bug fixes and features, I have made an effort to beautify some of the code, and speed everything up in general, based on code profiling. This will be evident if your Pushy program performs a lot of proxying: 0.5 performs up to ~2x &nbsp;faster than 0.4 in my tests.<br /><br /><br /><span class="Apple-style-span" style="font-size: large;"><b>New Features</b></span><br /><br />There are two new features in Pushy 0.5: with-statement support, and a simple &ldquo;execute&rdquo; interface.<br /><br /><b>With-statement support</b><br />Pushy connections now support the &ldquo;with&rdquo; statement. This is functionally equivalent to wrapping a Pushy connection with &ldquo;contextlib.closing&rdquo;: it will close the connection when the with-statement exits. For example:<br /><br /><pre class="brush: python">with pushy.connect(&ldquo;local:&ldquo;) as con:<br />    &hellip;<br /></pre><br /><b>Compile/execute interface </b><br />Previously if you wanted to execute a statement in the remote interpreter, you would have to first obtain the remote &ldquo;compile&rdquo; built-in function, invoke it to compile a remote code object, and then evaluate that with the &ldquo;connection.eval&rdquo; method. For example, to execute &ldquo;print &lsquo;Hello, World!&rsquo;&rdquo;:<br /><br /><pre class="brush: python">code_obj = con.eval(&ldquo;compile&rdquo;)(&ldquo;print &lsquo;Hello, World!&rsquo;&rdquo;, &ldquo;&lt;filename&gt;&rdquo;, &ldquo;exec&rdquo;)<br />con.eval(code_obj, locals=&hellip;, globals=&hellip;)<br /></pre><br />This is a bit unfriendly, so I thought it would be a good idea to add a simpler interface. There are two new methods: &ldquo;connection.compile&rdquo; and &ldquo;connection.execute&rdquo;. The former will compile a remote code object, and the latter executes either a string (statement) or a function. Continuing our very simple example, we get the much simpler:<br /><br /><pre class="brush: python">con.execute(&ldquo;print &lsquo;Hello, World!&rsquo;&rdquo;)<br /></pre><br />Under the hood, this will do exactly what we would previously have had to do manually: remotely compile the statement and then evaluate the resultant code object. Now that suffices for a very simple use case like we have discussed above, but what if we want to execute a series of statements? Wouldn&rsquo;t it be nice if we could remotely execute a locally defined function? Well, now you can, using &ldquo;connection.compile&rdquo;.<br /><br /><pre class="brush: python">def local_function(*args, **kwargs):<br />    return (args, kwargs)<br />remote_function = con.compile(local_function)<br />remote_function(&hellip;)<br /></pre><br />The &ldquo;connection.compile&rdquo; method will take a locally defined function and define it in the remote interpreter. It will then return a reference to the remote function, so that we can invoke it as if it were a local function. This allows the user to define complex and/or expensive logic that will be executed entirely remotely, only communicating back to the peer when proxy objects are involved, or to return the result.<br /><br /><br /><b><span class="Apple-style-span" style="font-size: large;">Bug Fixes</span></b><br /><br />The most noteworthy bugs fixed in 0.5 are:<br /><br /><b>#738216 Proxied old-style classes can&rsquo;t be instantiated</b><br />Old-style/classic classes (i.e. those that don&rsquo;t inherit from &ldquo;object&rdquo;) previously could not be instantiated via a Pushy connection. This has been rectified by defining an additional proxy type for old-style classes.<br /><b><br /></b><br /><b>#733026 auto-importer doesn&rsquo;t support modules not imported by their parent</b><br />Previously, importing a remote submodule via &ldquo;connection.modules&rdquo; would only work if the parent of the submodule imported it. For example, &ldquo;connection.modules.os.path&rdquo; would work since os imports os.path. If the parent does not import the submodule, Pushy would fail to import the module. This has been fixed in 0.5; remotely imported modules will provide the same sort of automagical importing interface as &ldquo;connection.modules&rdquo;.<br /><b><br /></b><br /><b>#734311 Proxies are strongly referenced and never deleted; <strong>del</strong> isn&rsquo;t transmitted to delete proxied object</b><br />This is the most significant change in Pushy 0.5. Since inception, Pushy has never released proxy objects, meaning eventual memory bloating for objects that would otherwise by garbage collected. As of 0.5, Pushy will now garbage collect proxies by default. Every so often (by default, 5 seconds), Pushy will send a message to the peer to let it know which proxies have been garbage collected. This allows the peer to release the proxied objects, and reclaim resources.<br /><b><br /></b><br /><b>#773811 Daemon/socket transport is slow</b><br />Due to the many small messages sent back and forth by Pushy, the &ldquo;daemon&rdquo; transport was found to be quite slow in stress testing. This is due to&nbsp;<a href="http://en.wikipedia.org/wiki/Nagle's_algorithm">Nagle&rsquo;s Algorithm</a>, which delays sending network packets so that they can be combined. This has a considerable impact on the latency of Pushy&rsquo;s operations, and so it is now disabled by Pushy.<br /><br />Enjoy!</p>

      </div>
      <h2 class="subtitle is-6">
      Posted May 23, 2011.
      
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/blogger/fabric-and-pushy-together-at-last/">Fabric and Pushy, together at last</a></h1>
      <div class="content">
        <p>A workmate of mine recently brought <a href="http://fabfile.org/">Fabric </a>to my attention. If you&rsquo;re not familiar with Fabric, it is a command-line utility for doing sys-admin type things over SSH. There&rsquo;s an obvious overlap with <a href="http://awilkins.id.au/pushy/">Pushy</a> there, so I immediately thought, &ldquo;Could Pushy be used to back Fabric? What are the benefits, what are the downsides?&rdquo;<div><br /></div><div>A couple of fairly significant benefits:<br /><div><ul><li>Pushy does more than just SSH, so Fabric could conceivably be made to support additional transports by using Pushy (which uses Paramiko), rather than using Paramiko directly.</li><li>Pushy provides access to the entire Python standard library, which is largely platform independent. So you could do things like determine the operating system name without using &ldquo;uname&rdquo;, which is a *NIX thing. That&rsquo;s a trivialisation, but you get the idea I&rsquo;m sure.</li></ul>One big fat con:<br /><ul><li>Pushy absolutely requires Python on the remote system (as well as SSH, of course, but Fabric requires that anyway.) So requiring Pushy would mean that Fabric would be restricted to working only with remote machines that have Python installed. Probably a safe bet in general, but not ideal.</li></ul><div>How about using Pushy if Python is available, and just failing gracefully if it doesn&rsquo;t? This turns out to be really easy to do, since Fabric and Pushy both use Paramiko. So I wrote a Fabric &ldquo;<a href="http://docs.fabfile.org/en/1.0.0/api/core/operations.html">operation</a>&rdquo; to import a remote Python module. Under the covers, this piggy-backs a Pushy connection over the existing Paramiko connection created by Fabric. I&rsquo;ll bring this to the attention of the Fabric developers, but I thought I&rsquo;d just paste it here for now.</div></div></div><br /><div>First an example of how one might use the &ldquo;remote_import&rdquo; operation. Pass it a module name, and you&rsquo;ll get back a reference to the remote module. You can then use the module as you would use the module as if you had done a plain old &ldquo;import <module>&rdquo;.<br /></div><br /><div><h3>fabfile.py</h3><pre class="brush: python">from fabric_pushy import remote_import<br /><br />def get_platform():<br />    platform = remote_import(&ldquo;platform&rdquo;)<br />    print platform.platform()<br /></pre></div><br /><div>You just execute your fabfile as per usual, and the &ldquo;remote_import&rdquo; operation will create a Pushy connection to each host, import the remote Python interpreter&rsquo;s standard <a href="http://docs.python.org/library/platform.html">platform</a> module, and call its platform method to determine its platform name. Easy like Sunday morning&hellip;<br /><pre>    $ fab -H localhost get_platform<br />    [localhost] Executing task &lsquo;get_platform&rsquo;<br />    Linux-2.6.35-27-generic-i686-with-Ubuntu-10.10-maverick<br /><br />    Done.<br />    Disconnecting from localhost&hellip; done.<br /></pre></div><br /><div><h3>fabric_pushy.py</h3><pre class="brush: python">from fabric.state import env, default_channel<br />from fabric.network import needs_host<br /><br />import pushy<br />import pushy.transport<br />from pushy.transport.ssh import WrappedChannelFile<br /><br />class FabricPopen(pushy.transport.BaseTransport):<br />    &ldquo;&rdquo;&rdquo;<br />    Pushy transport for Fabric, piggy-backing the Paramiko SSH connection<br />    managed by Fabric.<br />    &ldquo;&rdquo;&rdquo;<br /><br />    def <strong>init</strong>(self, command, address):<br />        pushy.transport.BaseTransport.<strong>init</strong>(self, address)<br /><br />        # Join arguments into a string<br />        args = command<br />        for i in range(len(args)):<br />            if &ldquo; &rdquo; in args[i]:<br />                args[i] = &ldquo;&lsquo;%s&rsquo;&rdquo; % args[i]<br />        command = &ldquo; &ldquo;.join(args)<br /><br />        self.<strong>channel = default_channel()<br />        self.</strong>channel.exec_command(command)<br />        self.stdin  = WrappedChannelFile(self.<strong>channel.makefile(&ldquo;wb&rdquo;), 1)<br />        self.stdout = WrappedChannelFile(self.</strong>channel.makefile(&ldquo;rb&rdquo;), 0)<br />        self.stderr = self.__channel.makefile_stderr(&ldquo;rb&rdquo;)<br /><br />    def <strong>del</strong>(self):<br />        self.close()<br /><br />    def close(self):<br />        if hasattr(self, &ldquo;stdin&rdquo;):<br />            self.stdin.close()<br />            self.stdout.close()<br />            self.stderr.close()<br />        self.__channel.close()<br /><br /># Add a &ldquo;fabric&rdquo; transport&rdquo;, which piggy-backs the existing SSH connection, but<br /># otherwise operates the same way as the built-in Paramiko transport.<br />class pseudo_module:<br />    Popen = FabricPopen<br />pushy.transports[&ldquo;fabric&rdquo;] = pseudo_module<br /><br />###############################################################################<br /><br /># Pushy connection cache<br />connections = {}<br /><br />@needs_host<br />def remote_import(name, python=&ldquo;python&rdquo;):<br />    &ldquo;&rdquo;&rdquo;<br />    A Fabric operation for importing and returning a reference to a remote<br />    Python package.<br />    &ldquo;&rdquo;&rdquo;<br /><br />    if (env.host_string, python) in connections:<br />        conn = connections[(env.host_string, python)]<br />    else:<br />        conn = pushy.connect(&ldquo;fabric:&ldquo;, python=python)<br />        connections[(env.host_string, python)] = conn<br />    m = getattr(conn.modules, name)<br />   if &ldquo;.&rdquo; in name:<br />        for p in name.split(&ldquo;.&rdquo;)[1:]:<br />            m = getattr(m, p)<br />    return m<br /></pre></div></p>

      </div>
      <h2 class="subtitle is-6">
      Posted March 9, 2011.
      
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/blogger/pushy-0.4-released/">Pushy 0.4 Released</a></h1>
      <div class="content">
        <div>I'm pleased to announce a new release of Pushy, version 0.4. This release has been concerned primarily with improving the existing code quality, fixing bugs that have been found in the use of 0.3, and adding missing functionality to the Java API.</div><div><br /></div><div>You can install Pushy with easy_install ("easy_install pushy"), or grab the source distribution from here:&nbsp;<a href="https://launchpad.net/pushy/+download">https://launchpad.net/pushy/+download</a>.&nbsp;I have also been working on some more documentation and getting-started type content on the brand spanking new website: <a href="http://awilkins.id.au/pushy">http://awilkins.id.au/pushy</a>.</div><div><br /></div><div>Do you use Pushy? What for? Do you have any ideas for improvements? Leave a comment here, or drop me an email at&nbsp;<a href="mailto:axwalk@gmail.com">axwalk@gmail.com</a>. I'd really appreciate some feedback!</div>

      </div>
      <h2 class="subtitle is-6">
      Posted March 5, 2011.
      
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/blogger/java-pushy-api/">Java Pushy API</a></h1>
      <div class="content">
        <p>It&rsquo;s been some time since I&rsquo;ve spruiked Pushy, so here we go.&nbsp;One of my colleagues was talking the other day about how he had implemented a <a href="http://nc110.sourceforge.net/">netcat</a>-like service for <a href="http://staf.sourceforge.net/">STAF</a>, an automation framework aimed at testing. This got me thinking about how this could be done relatively easily, using the <i>pushy.net</i>&nbsp;package, something I haven&rsquo;t written about much, primarily because it&rsquo;s still a work in progress.<br /><br /><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">Back in version 0.3, I introduced a Java API to Pushy, as I mentioned in an&nbsp;<a href="http://axwalk.blogspot.com/2010/07/java-to-python.html">earlier post</a>. I briefly mentioned the incorporation of packages which mimic, and in many cases are interface compatible with, packages in the Java standard library such as <i>java.io</i> and <i>java.net</i>.</div><div><br /></div><div>The <i>pushy.net</i>&nbsp;package currently contains three main classes:</div><div><ul><li>RemoteInetSocketAddress (extends java.net.InetSocketAddress)</li><li>RemoteSocket (extends java.net.Socket), and</li><li>RemoteServerSocket (extends java.net.ServerSocket).</li></ul><div>RemoteInetSocketAddress simply provides a means of creating an InetSocketAddress whose address is resolved at the remote host. RemoteSocket is a wrapper around a remote Python socket object, but extends java.net.Socket&nbsp;to provide a familiar interface to Java developers. Similarly, RemoteServerSocket extends java.net.ServerSocket, and wraps a remote Python socket object.</div><div><br /></div><div>So how about netcat emulation? Well, I won&rsquo;t cover the whole implementation of a netcat clone, as that would be a non-trivial undertaking. But I will show you one of the fundamental requirements: to bind a server socket, accept a client connection, and print out the data received from that client.</div></div><div><br /></div><div><b>Step 1.&nbsp;Bind a socket, and listen for connections.</b><br /><br /><pre class="brush:java">import java.net.ServerSocket;<br />import java.net.Socket;<br />import pushy.Client;<br /><br />public class Test {<br />    public static void main(String[] args) throws Exception {<br />        Client conn = new Client(&ldquo;local:&ldquo;);<br />        try {<br />            ServerSocket server = new pushy.net.RemoteServerSocket(conn, 0);<br />            try {<br />            } finally {<br />                server.close();<br />            }<br />        } finally {<br />            conn.close();<br />        }<br />    }<br />}<br /></pre><br />In this code snippet, we&rsquo;re creating a RemoteServerSocket, and assigning it to a java.net.ServerSocket, to illustrate interface compatibility. The first argument to the constructor is the <i>pushy.Client</i> object we previously created, and the second argument is the port to bind to. Specifying a port of zero, means that we want to bind to an ephemeral port.<br /><br />The creation of the RemoteServerSocket involves creating a Python socket object on the remote host, and performing the <i>bind</i> and <i>listen</i> methods on it.<br /><br /><b>Step 2. Accept a client connection.</b><br /><br /><pre class="brush:java">Socket client = server.accept();<br />try {<br />} finally {<br />    client.close();<br />}<br /></pre><br />Here we can see that accepting a client connection is exactly as we would do with a standard java.net.ServerSocket. This probably isn&rsquo;t surprising, since we&rsquo;ve upcasted our RemoteServerSocket to a plain old ServerSocket. One thing of interest here is that the Server object returned is in fact a RemoteServerSocket, wrapping a remote Python socket object.<br /><br /><b>Step 3. Read data from the client connection.</b><br /><br /><pre class="brush:java">InputStream in = client.getInputStream();<br />byte[] buf = new byte[1024];<br />int nread = in.read(buf, 0, buf.length);<br />while (nread != -1) {<br />    System.out.write(buf, 0, nread);<br />    System.out.flush();<br />    nread = in.read(buf, 0, buf.length);<br />}<br /></pre><br />Et voila! We can read the remote socket&rsquo;s output via a java.io.InputStream object, returned by the <i>getInputStream</i> method, which is overridden by RemoteSocket. One thing you may have noticed: to run this all on the local host, sans Pushy, you could substitute the right-hand side of the initial ServerSocket construction with a standard ServerSocket, and the rest of the code would remain unchanged.<br /><br />There are a few defects in the 0.3 release related to the pushy.net package, which will prevent these examples from working. I have rectified them in the process of writing this post. If you grab the trunk, it should all work nicely. There is <a href="https://bugs.launchpad.net/pushy/+bug/716393">one defect remaining</a>: the InputStream returned by RemoteSocket is based on a a file returned by Python&rsquo;s <i>socket.makefile</i> method. This differs from the InputStream returned by Java&rsquo;s standard Socket, in that a request for N bytes will not return until all N bytes, or EOF, are received. I hope to have this fixed in the coming days.<br /><br /></div></p>

      </div>
      <h2 class="subtitle is-6">
      Posted February 10, 2011.
      Tags: <a href="/tags/java">java</a>, <a href="/tags/pushy">pushy</a>.
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/blogger/facebook-puzzles/">Facebook Puzzles</a></h1>
      <div class="content">
        <p>So a couple of weeks ago I came across a <a href="http://forums3.xkcd.com/viewtopic.php?f=11&amp;t=67309">forum post on XKCD</a> about programming puzzles.Figuring that&rsquo;s a significantly better way to while away the hours I&rsquo;d previously been spending playing computer games, I thought I&rsquo;d take a crack.<br /><br />So after browsing around, I came across <a href="http://www.facebook.com/careers/puzzles.php">Facebook Puzzles</a>, which seems to be part of Facebook&rsquo;s recruitment tools. Solve some puzzles, apply for a job, and say how rad you are for having solved all of their puzzles. Something like that. Anyway, I had no intention of applying to Facebook, I just wanted to revive my fading computer science knowledge, and have a bit of fun in the progress. I don&rsquo;t see what the big fuss is about working there; so many other companies are producing much more interesting, constructive things.<br /><br />Naturally I went straight to the most difficult puzzle on the list, <a href="http://www.facebook.com/careers/puzzles.php?puzzle_id=1">Facebull</a>. It didn&rsquo;t take long for me to realise this was an NP-hard problem. It&rsquo;s fairly straight forward to see that this is a graph problem. A little more formally, we&rsquo;re given a directed graph (digraph), and we&rsquo;re asked to find a minimum cost strongly-connected sub-digraph, containing all vertices, but a subset of the edges.<br /><br />Spoilers ahead. Turn back now if you don&rsquo;t want any help.<br /><br />Originally I had thought that it was the Asymmetric Traveling Salesman Problem (ATSP) in disguise, which is just the Traveling Salesman Problem (TSP) with directed edges. I spent a couple of hours here and there reading the literature, since I didn&rsquo;t know anything about exact solutions (which is what the puzzle requires), and was only vaguely aware of approximation algorithms (which might help, for example, to reduce the search space.)&nbsp;For anyone wanting to read up on the TSP problem, I would definitely recommend the survey paper <i>The Traveling Salesman Problem</i>, by Jünger, Reinelt and Rinaldi. Also, <a href="http://iris.gmu.edu/~khoffman/papers/trav_salesman.html">this website</a> provides a great, gentle introduction.<br /><br />Not too long after, it dawned on me that the problem was not ATSP at all, since vertices (&ldquo;compounds&rdquo;) might be visited more than once. For example, consider a graph with the following edges:<br />&nbsp;&nbsp; &nbsp;(C1, C2), (C2, C1)<br />&nbsp;&nbsp; &nbsp;(C1, C3), (C3, C1)<br />This could not be solved by the ATSP, since we would have to visit C1 twice to complete a cycle from C1 to C2 to C3 and back to C1. However, it is required to be solvable for the Facebull puzzle. Back to the drawing board&hellip;<br /><br />The general approach I took was similar to the one that would be taken for ATSP, though, and that is to use a &ldquo;Branch and Bound&rdquo; algorithm. This is a fancy way of saying, enumerate all possible solutions, backtracking at the earliest possible opportunity by computing lower and upper bounds. For example, we might start with an upper bound of infinity, and update it whenever we find a candidate solution with a lower cost than the upper bound. A lower bound can be computed by taking into a constraint: each vertex must have an in-degree of at least one, and an out-degree of at least one. By remembering the cost of each edge in the graph, we can easily compute a lower bound.<br /><br />Is this enough? Perhaps, but we can do better. One more thing we can do is to prune edges. For example, if we have the edges (Ci, Cj), (Ci, Ck), and (Ck, Cj), and the sum of the cost of the latter two is less than the cost of the first, then we can eliminate the first.<br /><br />In total, I submitted my solution nine times. Why so many, you might ask? Because I didn&rsquo;t parse the input correctly, and didn&rsquo;t realise this while I was banging my head against the problem for two weeks. I wasn&rsquo;t handling white space at the end of the file, and I (foolishly) assumed that the test cases would not assign multiple edges to the same pair of vertices. Why would you have such a trivial test case to trip people up, when the underlying puzzle is hard enough as it is? It turns out my accepted solution (written in C++) ran in 300ms, so I guess the focus was more or less centred on correctness, rather than speed. That was a little frustrating, but at least I had some fun and learnt a few tricks along the way.<br /><br />There is still something wrong with my solution, however. It is not finding the optimal solution to some of the test cases people have published. But it passed the puzzle robot, so that&rsquo;s the main thing that matters. I had one more optimisation, which was to identify edges which are absolutely required, up-front. This can be done very cheaply, and may significantly reduce the search space in sparse graphs. This optimisation was interacting badly with my enumeration function, though; I&rsquo;m not sure what the problem is, perhaps I&rsquo;ll go back and take another look some time.<br /><br />Now, back to wasting my time playing computer games&hellip;</p>

      </div>
      <h2 class="subtitle is-6">
      Posted February 6, 2011.
      
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/blogger/pushy-public-documentation/">Pushy Public Documentation</a></h1>
      <div class="content">
        <p>So, I finally got around to writing some proper <a href="http://packages.python.org/pushy/">documentation for Pushy</a>.<br /><br />I had originally used <a href="http://epydoc.sourceforge.net/">Epydoc</a> to extract docstrings, and generate API documents, which I have been hosting. Then I realised I could publish HTML to <a href="http://pypi.python.org/pypi">PyPI</a>, so I thought I&rsquo;d do something a little more friendly than presenting the gory details of the API.<br /><br />In the past I&rsquo;ve used&nbsp;<a href="http://www.methods.co.nz/asciidoc/">Asciidoc</a>,&nbsp;a lightweight markup language, in the vein of Wiki markup languages. I found Asciidoc fairly simply to write, and there is a standard tool for processing and producing various output, including of course HTML. I wanted to make my documentation to have the look and feel of the Python standard library, so I&rsquo;ve been looking into&nbsp;<a href="http://docutils.sourceforge.net/rst.html">reStructuredText</a>.<br /><br />I have to say that reStructuredText is very easy to learn, and&nbsp;<a href="http://sphinx.pocoo.org/">Sphinx</a>, which is the processing tool used to generate the HTML output for the Python documentation, is a pleasure to use. The format of reStructuredText is similar to that of Asciidoc. So far I don&rsquo;t have any particular affinity to either - I mainly went with reStructuredText/Sphinx for the Python documentation theming.</p>

      </div>
      <h2 class="subtitle is-6">
      Posted August 7, 2010.
      
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/blogger/java-to-python/">Java-to-Python</a></h1>
      <div class="content">
        <p>Did you ever want to call Python code from Java?<br /><br />Until Java 5, I wasn&rsquo;t much of a fan of the Java language. The addition of enums, generics, and some syntactic sugar (e.g. foreach) makes it more bearable to develop in. But all of this doesn&rsquo;t change the fact that Java purposely hides non-portable operating system functions, such as signal handling and Windows registry access. Sure, you can do these things with JNI, but that makes application deployment significantly more complex.<br /><br />Python, on the other hand, embraces the differences between operating systems. Certainly where it makes sense, platform-independent interfaces are provided - just like Java, and every other modern language. But just because one platform doesn&rsquo;t deal in signals shouldn&rsquo;t mean that we can&rsquo;t use signals on Linux/UNIX.<br /><br />I realise it&rsquo;s probably not the most common thing to do, but calling Python code from Java needn&rsquo;t be difficult. There&rsquo;s <a href="http://jython.org/">Jython</a>, which makes available a large portion of the Python standard library, but still has some way to go. Some modules are missing (e.g. _winreg, ctypes), and others are incomplete or buggy. That&rsquo;s not to say that the project isn&rsquo;t useful, it&rsquo;s just not 100% there yet.<br /><br />Enter <a href="http://launchpad.net/pushy">Pushy </a>(version 0.3). In version 0.3, a Java API was added to Pushy, making it possible to connect to a Python interpreter from a Java program, and access objects and invoke functions therein. So, for example, you now have the ctypes module available to your Java program, meaning you can load shared objects / DLLs and call arbitrary functions from them. See below for a code sample.<br /><br /><pre class="brush:java">import pushy.Client;<br />import pushy.Module;<br />import pushy.PushyObject;<br /><br />public class TestCtypes {<br />    public static void main(String[] args) throws Exception {<br />        Client client = new Client(&ldquo;local:&ldquo;);<br />        try {<br />            // Import the &ldquo;ctypes&rdquo; Python module, and get a reference to the<br />            // GetCurrentProcessId function in kernel32.<br />            Module ctypes = client.getModule(&ldquo;ctypes&rdquo;);<br />            PushyObject windll = (PushyObject)ctypes.<strong>getattr</strong>(&ldquo;windll&rdquo;);<br />            PushyObject kernel32 = (PushyObject)windll.<strong>getattr</strong>(&ldquo;kernel32&rdquo;);<br />            PushyObject GetCurrentProcessId =<br />                (PushyObject)kernel32.<strong>getattr</strong>(&ldquo;GetCurrentProcessId&rdquo;);<br /><br />            // Call GetCurrentProcessId. Note that the Python interpreter is<br />            // running in a separate process, so this is NOT the process ID<br />            // running the Java program.<br />            Number pid = (Number)GetCurrentProcessId.<strong>call</strong>();<br />            System.out.println(pid);<br />        } finally {<br />            client.close();<br />        }<br />    }<br />}<br /></pre><br /><div class="separator" style="clear: both; text-align: center;"></div>Neat, eh? What I have demonstrated here is the following:<br /><br /><ul><li>Connecting a Java program to a freshly created Python interpreter on the local host.</li><li>Importing the ctypes module therein, and then getting a reference to kernel32.dll (this assumes Windows, obviously. It would be much the same on Linux/UNIX platforms.)</li><li>Executing the GetCurrentProcessId function to obtain the process ID of the Python interpreter, and returning the result as a java.lang.Number object.</li></ul>The final point is an important one. Pushy automatically casts types from Python types to their Java equivalent. For example, a Python dictionary object will be returned as a java.util.Map. If that map is modified, then the changes will be made in the remote dictionary object also. Tuples, which are immutable, are returned as arrays, whilst Python lists are returned as java.util.List objects.<br /><br />The Pushy Java API aims to provide Java standard library&nbsp;equivalent interfaces to Python standard library modules where possible. For example, there is a <i>pushy.io</i>&nbsp;package for dealing with files in the Python interpreter using &nbsp;<i>java.io.</i>-like classes. Similarly, a <i>pushy.net</i>&nbsp;package exists for performing socket operations using a <i>java.net</i>-like interface.<br /><br />One can also connect to SSH hosts, as is possible through the Pushy Python API. This is achieved by creating a connection to a local Python interpreter, and thence to the remote system using the&nbsp;Pushy&nbsp;Python API in the subprocess. This is all done transparently if a target other than &ldquo;local:&rdquo; is specified in the Java program.<br /><br />Enjoy!</p>

      </div>
      <h2 class="subtitle is-6">
      Posted July 10, 2010.
      
      </h2>
    </article>
    
  </div>
</section>

<section class="section">
  <div class="container">
    <nav class="level is-mobile">
      <div class="level-left">
        <div class="level-item">
          
          <a class="button" href="/post/page/3/">
            <span class="icon is-small is-marginless">
              <i class="fa fa-angle-left"></i>
            </span>
            Newer
          </a>
          
        </div>
      </div>
      <div class="level-right is-marginless">
        <div class="level-item">
          
          <a class="button" href="/post/page/5/">
            Older
            <span class="icon is-small is-marginless">
              <i class="fa fa-angle-right"></i>
            </span>
          </a>
          
        </div>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container has-text-centered">
    <p></p>
  </div>
</section>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/python.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-17223840-3', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>



