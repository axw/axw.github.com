<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>awilkins.id.au</title>
<link rel="stylesheet" href="https://awilkins.id.au//css/style.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/github.min.css">


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
	
	<a class="nav-item" href="https://awilkins.id.au/">
	<h1 class="title is-4" style="color: #666666; font-weight: bold">
	a<span style="color:#4a83d4; font-weight: bold">wilkins</span>.id.<span style="color:#4a83d4; font-weight: bold">au</span>
	</h1>
	</a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/axw">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/yayxw">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
          <a class="level-item" href="/index.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/juju-2.3-storage/">Coming in Juju 2.3: storage improvements</a></h1>
      <div class="content">
        

<p>I&rsquo;ve just about wrapped up a set of improvements to storage for
<a href="https://jujucharms.com/">Juju</a> 2.3, the next &ldquo;minor&rdquo; release.
If you&rsquo;re already using, or have been planning to use Juju&rsquo;s
storage support, read on.</p>

<h3 id="dynamic-storage-management">Dynamic storage management</h3>

<p>Juju charms can specify storage requirements: the number of
filesystems or block devices its application requires. For
example, the <a href="https://jujucharms.com/postgresql">PostgreSQL</a>
charm requires a filesystem on which to store the database.
If you don&rsquo;t tell Juju otherwise, the storage will go onto
the root filesystem, but you can also tell Juju to provide
the charm with cloud storage (Amazon EBS, OpenStack Cinder,
etc.)</p>

<p>One of the missing pieces that users have been asking for is
the ability to manage the lifecycle of storage independently
of applications and units, and to reuse existing storage. In
Juju 2.3, when you remove an application or unit, the storage
attached to the unit(s) will (if possible) be detached, rather
than destroyed, and will remain in the model. You can then
either remove the storage using <code>juju remove-storage</code>, or
attach it to a new unit using the new <code>juju attach-storage</code>
command, or the <code>--attach-storage</code> flag added to <code>juju deploy</code>
and <code>juju add-unit</code>. To complement <code>juju attach-storage</code>, there
is also a new <code>juju detach-storage</code> command.</p>

<p>So to illustrate, you can now deploy PostgreSQL with cloud
storage, then remove the application, and redeploy (e.g. with
more RAM), using the same storage.</p>

<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">juju deploy postgresql --storage=10G
…
juju remove-application postgresql
…
juju deploy postgresql --constraints mem=16G --attach-storage pgdata/0
</pre></div>


<p>We&rsquo;re still working on giving you commands to remove storage
from the model without destroying it, and then import it into
a new model (possibly new controller). This is required
for disaster recovery. Whether this makes it for 2.3 depends
on prioritisation; if it doesn&rsquo;t make it for 2.3, it shouldn&rsquo;t
be far behind.</p>

<h3 id="lxd-storage-provider">LXD Storage Provider</h3>

<p>One thing that we hadn&rsquo;t planned for 2.3, but we did manage to
get done, is a LXD storage provider. <a href="https://insights.ubuntu.com/2017/07/12/storage-management-in-lxd-2-15/">LXD has recently added
its own storage management API</a>,
and Juju 2.3 will have a storage provider that uses it. I
originally implemented the Juju side of things as a bit of a
hack, behind a feature flag, in order to speed up the development
of the aforementioned attach/detach changes. The LXD storage
API turned out to be very straight forward to build on, so we
decided to release the Juju changes into the wild in case it&rsquo;s
of use to others. Particularly if you&rsquo;re developing or testing
charms that use storage, this should be useful.</p>

<p>Using the LXD storage provider is as simple as:</p>

<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">juju deploy postgresql --storage=10G,lxd
</pre></div>


<p>Each storage pool using the &ldquo;lxd&rdquo; storage provider will create
an associated storage in LXD. When you create a storage pool
in Juju, you need to specify two configuration attributes:</p>

<ul>
<li>the LXD storage pool name, as the &ldquo;lxd-pool&rdquo; attribute</li>
<li>the LXD storage driver, as the &ldquo;driver&rdquo; attribute</li>
</ul>

<p>You can also define driver-specific attributes, which will be
passed through to the LXD storage driver verbatim.</p>

<p>Juju predefines a &ldquo;lxd-zfs&rdquo; pool, with the following attributes:</p>

<ul>
<li>lxd-pool=juju-zfs</li>
<li>driver=zfs</li>
<li>zfs.pool_name=juju-zfs</li>
</ul>

<p>If you deploy an application with storage using the lxd-zfs
pool, Juju will create a LXD storage pool called &ldquo;juju-zfs&rdquo;
with the &ldquo;zfs&rdquo; driver, and ZFS pool called &ldquo;juju-zfs&rdquo;. To
find out more about the LXD storage driver options, see the
<a href="https://github.com/lxc/lxd/blob/master/doc/storage.md">LXD storage docs</a>.</p>

      </div>
      <h2 class="subtitle is-6">
      Posted July 13, 2017.
      Tags: <a href="/tags/juju">juju</a>, <a href="/tags/storage">storage</a>, <a href="/tags/lxd">lxd</a>.
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/juju-2.1-lxd-centos/">Juju 2.1 and CentOS</a></h1>
      <div class="content">
        <p>In the <a href="https://jujucharms.com/">Juju</a> 2.1 release, I made a couple of small
changes to better support CentOS servers.</p>

<p>The first change was to support &ldquo;manual provisioning&rdquo; of CentOS machines.
Manual provisioning is when you point Juju at a machine, and Juju connects
to the machine over SSH and sets it up with a Juju agent. To do this, Juju
needs to run a small shell script to discover the OS version and hardware
characteristics of the machine. With a minor change to that script, you can
now manually provision CentOS machines.</p>

<p>The second change is to support CentOS LXD images. A small change was needed
in the Juju code to support the &ldquo;centos7&rdquo; OS version, and alter the way we
handle local LXD image aliases. If an image exists locally with the expected
alias (e.g. &ldquo;juju/centos7/amd64&rdquo;), then we&rsquo;ll use that and skip looking in
the remote image sources. This also improves container startup time when
you live in a faraway land like me. Altering Juju is not quite enough though,
as there are no existing CentOS images that Juju can use.</p>

<p>Juju (mostly) requires <a href="https://cloudinit.readthedocs.io/">cloud-init</a> to be
present on the machines it starts, so that it can inject Juju-specific configuration
and scripts to run on startup. Unforunately, there are no CentOS LXD images
that have cloud-init already. To work around this, I wrote a standalone Go
program to transform the <a href="https://linuxcontainers.org">linuxcontainers.org</a>
CentOS image: <a href="https://github.com/axw/juju-lxd-centos-image-builder">github.com/axw/juju-lxd-centos-image-builder</a>.
Eventually we hope to have pre-canned CentOS LXD images available to Juju,
but for now you can use this program to prepare an image for Juju. Run it from
the LXD host, and Juju will be able to use the resulting image.</p>

      </div>
      <h2 class="subtitle is-6">
      Posted February 23, 2017.
      Tags: <a href="/tags/juju">juju</a>, <a href="/tags/lxd">lxd</a>.
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/llgo-classic-snap/">llgo: classic snap</a></h1>
      <div class="content">
        <p>Some time ago I created a <a href="https://snapcraft.io/">snap</a> for
<a href="https://github.com/llvm-mirror/llgo">llgo</a>. Snaps are a
relatively new packaging format; at the time I created the
initial snap for llgo, it was only possible to create them
confined by default. In particular, access to the user&rsquo;s
filesystem was blocked by default, which is unhelpful for
a tool like a compiler. Because of that, the initial snap
did not expose the llgo compiler, only the llgoi interpreter.</p>

<p>Now there is the concept of &ldquo;classic snaps&rdquo;, which use the
snap packaging format but do not confine the application.
The resulting package is much more like what you would get
from a Debian package, but without the arcana.</p>

<p>I have released a new llgo classic snap, exposing the llgoi
interpreter, and the llgo compiler and &ldquo;go&rdquo; tool wrapper.
To install the llgo snap, run:</p>

<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">sudo snap install --classic llgo
</pre></div>


<p>The exposed &ldquo;llgo&rdquo; command is an alias for the go tool
wrapper, so you can just run:</p>

<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">$ llgo install &lt;package&gt;
$ llgo run /path/to/source.go
...
</pre></div>


<p>as you would with the standard go tool. The llgo compiler
itself can be invoked with the &ldquo;llgo.compiler&rdquo; command:</p>

<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">$ llgo.compiler -emit-llvm -S -o -o main.go
; ModuleID = <span style="font-style: italic">&#39;main&#39;</span>
source_filename = <span style="font-style: italic">&quot;main&quot;</span>
target datalayout ...
</pre></div>


<p>The llgoi interpreter is still available, but as it is part
of the same snap it is no longer confined:</p>

<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">$ llgo.llgoi
(llgo) import <span style="font-style: italic">&quot;fmt&quot;</span>
(llgo) fmt.Println(<span style="font-style: italic">&quot;hello, world&quot;</span>)
hello, world
13
&lt;nil&gt;
</pre></div>


      </div>
      <h2 class="subtitle is-6">
      Posted February 15, 2017.
      Tags: <a href="/tags/llgo">llgo</a>, <a href="/tags/snapcraft">snapcraft</a>.
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/juju-2.1-prometheus/">New in Juju 2.1: Prometheus Metrics</a></h1>
      <div class="content">
        

<p><a href="https://jujucharms.com/">Juju</a> is an application modelling tool,
enabling &ldquo;model-driven operations&rdquo;. I won&rsquo;t go into detail about
what Juju is in this blog post, so if you&rsquo;re new to Juju I suggest
clicking on the link and reading a bit more.</p>

<p>Juju is a distributed application, with a &ldquo;controller&rdquo; cluster that
manages cloud resources (machines, networks, volumes, etc.), and
applications that use those resources. The controller cluster is
currently based on top of MongoDB, utilising replica sets for data
replication and leadership election.</p>

<p>As well as the controller cluster, Juju agents run on every virtual
machine that the controller manages. The controllers, and those agents,
each run many fine-grained, but dedicated &ldquo;workers&rdquo;. For example,
each agent runs a worker to detect block devices and publish that
information to the controller cluster; each controller runs a worker
to maintain the replica sets in MongoDB.</p>

<p>Many things can go wrong in a distributed system. Network partitions
can cause system-wide failures. Bad actors (badly written; less often,
malicious) may starve others of resources. Failure to release memory
or file handles leads to exhaustion, causing a DoS. Juju has seen its
fair share of each of these problems.</p>

<p>To combat such issues, we have recently added Prometheus monitoring to
Juju. As of Juju 2.1, Juju controllers and agents will export Prometheus
metrics. There are two ways to get at them:</p>

<ul>
<li>(on controllers) an HTTPS endpoint, https://&hellip;:17070/introspection/metrics.</li>
<li>(on Linux agents) an abstract domain socket, @jujud-machine-&lt;machine-ID&gt;</li>
</ul>

<p><img src="/images/prometheus-juju-metrics.png" alt="Juju metrics available from Prometheus" /></p>

<h2 id="configuring-prometheus-to-scrape-juju-controllers">Configuring Prometheus to scrape Juju controllers</h2>

<p>To configure Prometheus to scrape metrics from Juju controllers, you will
need to add a new scrape target to Prometheus. The metrics endpoint requires
authorisation, so you will need to configure a user and password for
Prometheus to use:</p>

<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">$ juju add-user prometheus
$ juju change-user-password prometheus
new password: &lt;password&gt;
type new password again: &lt;password&gt;
</pre></div>


<p>For this new &ldquo;prometheus&rdquo; user to be able to access the metrics endpoint,
you must grant the user read access to the controller model:</p>

<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">$ juju grant prometheus read controller
</pre></div>


<p>This gives the prometheus user just enough permission to read information
on the controller, without allowing it to make changes, which would not
be ideal for a monitoring application.</p>

<p>Juju serves the metrics over HTTPS, currently with no option of degrading
to HTTP. You can configure your Prometheus to skip validation, or you can
store the controller’s CA certificate in a file for Prometheus to verify
the server’s certificate against:</p>

<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">$ juju controller-config ca-cert &gt; /path/to/juju-ca.crt
</pre></div>


<p>We can now add a scrape target to Prometheus. Modify prometheus.yml, adding
the following scrape target:</p>

<pre><code class="language-yaml">scrape_configs:
  job_name: juju
    metrics_path: /introspection/metrics
    scheme: https
    static_configs:
      targets: ['&lt;controller-address&gt;:17070']
    basic_auth:
      username: user-prometheus
      password: &lt;password&gt;
    tls_config:
      ca_file: /path/to/juju-ca.crt
</code></pre>

<p><img src="/images/prometheus-juju-api-requests-total.png" alt="Juju API requests total metric" /></p>

<h2 id="configuring-prometheus-to-scrape-juju-agents">Configuring Prometheus to scrape Juju agents</h2>

<p>To expose the metrics of agents, you can deploy the <a href="https://jujucharms.com/u/axwalk/juju-introspection">juju-introspection</a>
charm onto that agent&rsquo;s machine. For example, on machine 1, you would
run:</p>

<pre><code>juju deploy ~axwalk/juju-introspection --to 1
</code></pre>

<p>The metrics of that agent can then be obtained via:</p>

<pre><code>http://&lt;machine-1-address&gt;:19090/agents/machine-1/metrics
</code></pre>

<p>Note that this is not an officially supported charm. The code for it is available at:</p>

<ul>
<li><a href="https://github.com/axw/juju-introspection-charm">https://github.com/axw/juju-introspection-charm</a></li>
<li><a href="https://github.com/axw/juju-introspection-proxy">https://github.com/axw/juju-introspection-proxy</a></li>
</ul>

      </div>
      <h2 class="subtitle is-6">
      Posted February 6, 2017.
      Tags: <a href="/tags/juju">juju</a>.
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/old-posts/">Old blog posts</a></h1>
      <div class="content">
        <p>I have finally gotten around to moving off Blogger,
and over to using <a href="https://gohugo.io">Hugo</a>. The old
blog posts have been imported, and are also accessible
at <a href="https://axwalk.blogspot.com">my old Blogger site</a>.</p>

      </div>
      <h2 class="subtitle is-6">
      Posted December 31, 2016.
      
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/blogger/availability-zones-in-juju/">Availability Zones in Juju</a></h1>
      <div class="content">
        <p><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: center;"></div><div style="text-align: left;">You would be forgiven for thinking that I&rsquo;d fallen off the face of the earth, considering how long it has been since I last wrote. I&rsquo;ve been busy with my day job, moving into a new house; life in general. Work on <a href="https://github.com/go-llvm/llgo">llgo</a>&nbsp;has been progressing, mostly due to Peter Collingbourne. I&rsquo;ll have more to say about llgo&rsquo;s progress in future posts.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">This post is about some of the work I&rsquo;ve done on&nbsp;<a href="http://juju.ubuntu.com/">Juju</a>&nbsp;recently. Well, semi-recently; this post has been sitting in my drafts for a little while, waiting for the new 1.20.5 release to be announced.</div><div style="text-align: left;"><br /></div><br /><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-Pw7IeMRzbtM/U_K3cyQ5SRI/AAAAAAAAhIY/-Pl2Dh3TgGI/s1600/andnowforsomethingcompletelydifferent.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-Pw7IeMRzbtM/U_K3cyQ5SRI/AAAAAAAAhIY/-Pl2Dh3TgGI/s1600/andnowforsomethingcompletelydifferent.png" height="320" width="225" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><h2>Availability Zones in Juju</h2>One of the major focuses of the <a href="https://juju.ubuntu.com/docs/reference-release-notes.html">Juju 1.20 release</a> has been around high availability (HA). There are two sides to this: high availability of Juju itself, and high availability of your deployed services. We’ll leave the “Juju itself” side for another day, and talk about HA charms/services.<br /><br />Until now, if you deployed a service via a charm with Juju, your cloud instance containing the service unit would be allocated wherever the cloud provider decided best. Most cloud providers split their compute services up into geographic regions (“us-east-1” in Amazon EC2, “US West” in Microsoft Azure, etc.). Some providers also break those regions down into “availability zones” (though the actual term may vary between providers, we use the term availability zone to describe the concept). An availability zone is essentially an isolated subset of a region.<br /><br />If you’re developing an application that demands high availability, then you probably want to make sure your application is spread across availability zones. Some providers will guarantee a service level agreement (SLA) if you do this, such as on Microsoft Azure. Provided that you allocate at least two VMs to a “Cloud Service” on Azure, then you’re guaranteed a 99.95% uptime under the SLA and you get reimbursed if the guarantee isn’t met.<br /><br />In Juju 1.20, there are two options for distributing your service units across availability zones: explicit (akin to machine placement) and automatic. So far we have enabled explicit availability zone placement in the Amazon EC2 and OpenStack (Havana onwards) providers, with support for the <a href="https://maas.ubuntu.com/">MAAS</a> provider on the horizon. To add a new machine to a specific availability zone, use the “zone=” placement directive as below:<br /><blockquote class="tr_bq">juju add-machine zone=us-east-1b</blockquote><br />As well as support for explicit zone placement, we’ve implemented automatic spreading of services units across availability zones for Amazon EC2, OpenStack and Microsoft Azure. When cloud instances are provisioned, they will be allocated to an availability zone according to the density of the availability zone population for related instances. Two cloud instances are considered related if they both contain units of a common service, or if they are both Juju state servers.<br /><br />To illustrate automatic spread, consider the mongodb charm. You’re going to use MongoDB as the datastore for your application, and you want to make sure the datastore is highly available; to do that, you’ll want to create a <a href="http://docs.mongodb.org/manual/replication/">MongoDB replica set</a>. It’s trivial to do this with the mongodb Juju charm:<br /><blockquote class="tr_bq">juju deploy -n 3 mongodb</blockquote><br />Wait a little while and you’ll have a 3-node MongoDB replica set. If a node happens to disappear, then the replica set will rejig itself so that there is a master (if the master was in fact lost) and everything should continue to work. If all the nodes go away, then you’re in trouble. This is where you want to go a step further and ensure your nodes are distributed across availability zones for greater resilience to failure. As of Juju 1.20, that “juju deploy” you just did handles that all for you: your 3 nodes will be uniformly spread across availability zones in the environment. If you add units to the service, they will also be spread across the zones according to how many other units of the service are in the zones. Let’s see what Juju did…<br /><blockquote class="tr_bq">$ juju status mongodb | grep instance-id<br />instance-id: i-7a6d2b50<br />instance-id: i-ff1562d4<br />instance-id: i-627f0a30</blockquote><blockquote class="tr_bq">$ ec2-describe-availability-zones<br />AVAILABILITYZONE us-east-1a available us-east-1<br />AVAILABILITYZONE us-east-1b available us-east-1<br />AVAILABILITYZONE us-east-1d available us-east-1</blockquote><blockquote class="tr_bq">$ ec2-describe-instance-status i-7a6d2b50 i-ff1562d4 i-627f0a30 | grep i-<br />INSTANCE i-627f0a30 us-east-1d running 16 ok ok active<br />INSTANCE i-ff1562d4 us-east-1a running 16 ok ok active<br />INSTANCE i-7a6d2b50 us-east-1b running 16 ok ok active</blockquote><blockquote class="tr_bq">(Note: the ec2-* commands are available in the ec2-api-tools package.)</blockquote><br />Juju has distributed the mongodb units so that there is one in each zone, so if one zone is impaired the others will be unaffected. If we add a unit, it will go into one of the zones with the fewest mongodb units.<br /><br />Explicit placement is currently only supported by Juju’s Amazon EC2 and OpenStack providers, but automatic spread is also supported by the Microsoft Azure provider. Due to the way that Microsoft Azure ties together availability zones and load balancing, it is currently necessary to forego “density” (i.e. explicit machine placement) in order to support automatic spread. If you are upgrading an existing environment to 1.20, then automatic spread will not be enabled. Newly created environments enable spread (and disable placement) by default, with an option to disable (availability-sets-enabled=false in environments.yaml).<br /><br />Enjoy.<br /><br /></p>

      </div>
      <h2 class="subtitle is-6">
      Posted August 19, 2014.
      
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/blogger/llgo-on-ssa/">llgo on ssa</a></h1>
      <div class="content">
        <p>Hello there!<br /><br />I&rsquo;ve been busy hacking on <a href="http://github.com/axw/llgo" target="_blank">llgo</a> again. In case you&rsquo;re new here: llgo is a <a href="http://golang.org/" target="_blank">Go</a> frontend for <a href="http://llvm.org/" target="_blank">LLVM</a> that I&rsquo;ve been working on for the past ~2 years on and off. It&rsquo;s been quite a while since I last wrote; there has been a bunch of new work since, so I have some things to talk about at last.<br /><br />A few months ago, I started working on rewriting swathes of llgo&rsquo;s internals to base it on <a href="http://godoc.org/code.google.com/p/go.tools/ssa">go.tools/ssa</a>. LLVM uses an <a href="http://en.wikipedia.org/wiki/Static_single_assignment_form">SSA</a> representation, which made the process fairly straightforward. Basing llgo on go.tools/ssa gives me much higher confidence in the quality of the output; it also presented a good opportunity to clean up llgo&rsquo;s source itself, which I have begun, but certainly not finished. llgo is now able to compile all packages in the standard library, except those that require cgo (net, os/user, runtime/cgo).<br /><br />llgo now works something like this:<br /><ol><li>Go source is scanned and parsed by go/ast and go/parser, producing an AST;</li><li>The AST is fed into go/types, type-checking;</li><li>The output of go/types is passed onto go.tools/ssa, which generates the SSA form;</li><li>llgo translates the go.tools/ssa SSA form into an LLVM module,</li><li>llgo-build links the LLVM modules for a program together and translates to an executable.</li></ol><br />go.tools/ssa supports translating a whole program to SSA form, but llgo works in the traditional way: packages are translated one at a time. Whole program optimisation is enabled by linking the LLVM modules together, prior to any translation to machine code.<br /><br />There were a few bits that I stumbled on, when rewriting. Alan Donovan, the author of go.tools/ssa, was kind enough to give me some assistance along the way. Anyway, the main issues I had were:<br /><br /><ul><li>Translating Phi nodes requires a bit of finessing, to ensure processing of the Phi or the edges is not order-sensitive. This was dealt with by generating placeholder values for instructions that haven&rsquo;t yet been visited, and then replacing them later.</li><li>ssa.Index is emitted for indexing into arrays. If an array is in a register, then indexing it means extracting a value; in LLVM, an array element extraction requires a constant index. This is currently kludged by storing to a temporary alloca, and using the getelementptr LLVM instruction. Hopefully I&rsquo;m missing something and this is easily fixed.</li><li>The Recover block is not dominated by the entry block, so it may not be valid for it to refer to the Alloc instructions for parameters and results. To deal with this, I generate a prologue block that contains the param/result Allocs; the prologue block conditionally jumps to either the recover or entry block, depending on panic/recover control flow. Alan has agreed to do something along these lines in go.tools/ssa.</li><li>The ssa.Next instruction required some assumptions to be made about block ordering and instruction placement, in order to be able to translate string-range using Phi nodes. Recent changes to go.tools/ssa exposed&nbsp;the dominator tree, making it possible to do away with the assumption now.</li></ul><br /><br />Various significant changes have been made during the course of the migration to go.tools/ssa:<br /><ul><li>Interfaces are now represented like in gc: empty interfaces with the runtime type &amp; data, non-empty interfaces with an &ldquo;itab&rdquo; and data. Russ Cox wrote <a href="http://research.swtch.com/interfaces">an article about the interface representation</a> back in 2009.</li><li>Panic/recover (and defer, by consequence) are now using setjmp/longjmp. I had been using exceptions, but it was rightly pointed out to me that this wouldn&rsquo;t work unless there were a way of doing non-call exceptions in LLVM (which has not been implemented). The setjmp/longjmp approach incurs a cost for every function that may defer or recover, but it works without modifications to LLVM. Perhaps this will be revisited in the future.</li><li>go/types/typemap is now used for mapping types.Types to runtime type descriptors and LLVM types. Runtime type descriptors are now generated more completely, and more correctly. Identical type descriptors will now be merged at link-time.</li><li>llgo no longer generates conditional branching for calls to non-global functions, when comparing structs, or in map iteration. Apart from producing better code, this makes it much simpler to work with go.tools/ssa, which has its own idea about how the SSA basic blocks relate to one another.</li></ul><div><br />There have also been miscellaneous bug fixes, and improvements, not directly related to the move to go.tools/ssa. Some highlights:</div><ul><li>A custom importer/exporter, thanks to <a href="https://github.com/quarnster">Fredrik Ehnbom</a>. The importer side is disabled at the moment, due to an apparent <a href="https://code.google.com/p/go/issues/detail?id=7028">bug in go.tools/ssa</a>.</li><li>Debugger support, thanks again to Fredrik Ehnbom. I haven&rsquo;t reenabled it since the move to go.tools/ssa. I&rsquo;ll get onto that real soon now, because debugging without it can be tiresome.</li><li>llgo-build can now take a &ldquo;-test&rdquo; flag that causes llgo-build to compile the test Go files, yet again thanks to Fredrik Ehnbom. This is currently reliant on the binary importer being enabled, so it won&rsquo;t work out of the box until that bug is fixed.</li><li>Shifts now generate correct values for shifts greater than the width of the lhs operand.</li><li>Signed integer conversions now sign-extend correctly.</li><li>bytes.Compare now works as it should (-1, 0, 1, not &lt;0, 0, &gt;0). &ldquo;llgo-build -test bytes&rdquo;: PASS</li><li>llgo-build can now take a &ldquo;-run&rdquo; flag that causes llgo-build to execute and then dispose of the resulting binary.</li><li>Type strings are propagated to LLVM types, making the IR more legible, thanks to <a href="https://github.com/tmc">Travis Cline</a>.</li></ul><div><br />I <i>think</i> that&rsquo;s everything. I have various things I&rsquo;d like to tackle now, but not enough time to do it all at once. If you&rsquo;re interested in helping out then there&rsquo;s plenty to do, including:</div><br /><ul><li>Move to using libgo. Ideally the gc runtime would be rewritten in Go already, but that&rsquo;s not going to happen just yet. The compiler and linker are due to be rewritten in Go soon, which is a lot of work as it is.</li><li>Finish off runtime type descriptor generation (notably, type algorithms).</li><li>Get PNaCl support working again. This should be pretty close, but requires the binary importer to be enabled.</li><li>Implement cgo support.</li><li>Implement bounds checking, nil pointer checks, etc.</li><li>Get garbage collection working. There&rsquo;s <a href="https://github.com/axw/llgo/pull/108">Pull Request #108</a>, but this is perpetuating the problem that is llgo&rsquo;s custom runtime. Since GC is fairly invasive, I don&rsquo;t want to go tying llgo to that runtime any more than it is currently. I expect this will have to wait until libgo is integrated.</li><li>Escape analysis. This is a must-have, but not immediately&nbsp;necessarily. The implementation should be based&nbsp;on go.tools/ssa, interfacing with the exporter/importer to record/consume information about external functions.</li><li>Make use of go.tools/ssa/ssautil/Switches. This is an optimisation, so again, not immediately necessary.</li></ul><div><br />If you want to have a play around, then grab LLVM and Go, and then:<br /><br /><ul><li>go get github.com/axw/llgo/cmd/llgo-dist &amp;&amp; llgo-dist</li><li>llgo-build &lt;some/package&gt; <i>or</i> llgo-build file1.go, file2.go, &hellip;</li></ul><div>Let me know how you get on with that.</div><br /><br /></div><div>Here&rsquo;s hoping 2014 can be a productive year for llgo. Happy new year.</div><br /><br />Cheers,<br />Andrew<br /><br /></p>

      </div>
      <h2 class="subtitle is-6">
      Posted January 6, 2014.
      
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/blogger/llgo-update-14/">llgo update #14</a></h1>
      <div class="content">
        <p>Ahoy there, mateys!<br /><br />It&rsquo;s been three months since our last correspondence. Apologies for the negligence. I&rsquo;ve been busy, as usual, but it&rsquo;s more self-inflicted than usual. I&rsquo;ve taken up a new role at Canonical, working on <a href="http://juju.ubuntu.com/">Juju</a>.&nbsp;I&rsquo;m really excited about Juju (both the concept and realisation), and the fact that it&rsquo;s written in Go is icing on the cake. Working remotely is taking some getting used to, but so far it&rsquo;s been pretty swell. Anyway, you didn&rsquo;t come here to read about that, did you?<br /><br />I&rsquo;m still working on <a href="http://github.com/axw/llgo">llgo</a> in the background, quietly prodding it along towards the <a href="https://github.com/axw/llgo/issues?milestone=1&amp;state=open">0.1 milestone</a>. There&rsquo;s just one big ticket item left, and that&rsquo;s partially done now: channels. I&rsquo;ve just finished porting the basics of channels from gc&rsquo;s standard library to llgo&rsquo;s runtime. That doesn&rsquo;t include select, which is entirely missing. When that&rsquo;s done, I&rsquo;ll be content to release 0.1.<br /><br />So what&rsquo;s new since last time?<br /><br /><ul><li>There&rsquo;s a new llgo-build tool, which takes the pain out of building packages and programs with llgo and the LLVM toolchain. Just run &ldquo;llgo-build &lt;package&gt;&rdquo;, and you&rsquo;ll either build and install a package, or build a program in the working directory. There&rsquo;s no freshness checking, so you&rsquo;re currently required to manually build all dependencies before building a program.</li><li>Simplified building against PNaCl: llgo-dist now accepts a &ldquo;-pepper&rdquo; option, which points to a NaCl SDK.</li><li>Implemented support for map literals.</li><li>Implemented complex number arithmetic.</li><li>Implemented channels (apart from anything select-related)</li><li>Numerous bug fixes.</li></ul><div>In my previous post I talked about having implemented panic/recover, and having implemented them in terms of DWARF exception handling. Well, it looks like PNaCl isn&rsquo;t going to support that, at least initially, so a setjmp/longjmp version is likely inevitable now.</div><div><br /></div><div>I also said I would be working on a temporary for of cmd/go. I gave up on that, after hitting a few stumbling blocks. I figured it was more important to actually get the compiler and runtime working than get bogged down in the tooling, hence the simpler llgo-build tool.</div><div><br /></div><div>That&rsquo;s about it! &ldquo;Feature complete&rdquo; is getting closer, though lots of things still don&rsquo;t work very nicely. Still no garbage collection, no proper escape analysis, etc. Those will come in time.</div><div><br /></div><div>For now, though&hellip; I think I might go catch up on some sleep.</div></p>

      </div>
      <h2 class="subtitle is-6">
      Posted August 16, 2013.
      
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/blogger/llgo-on-go-1.1/">llgo on Go 1.1</a></h1>
      <div class="content">
        <p>Hi folks,<br /><br />(For those of you coming from HN/Twitter/elsewhere, this is a post about <a href="https://github.com/axw/llgo">llgo</a>. llgo is an LLVM frontend for the Go programming language).<br /><br />In my <a href="http://blog.awilkins.id.au/2013/03/llgo-update-12.html">last post</a> I mentioned that work had began on moving to Go 1.1 compatibility; this has been my primary focus since then. Since Go 1.1 is now released (woohoo!), I&rsquo;ve gone ahead and pulled all the changes back into the master branch on GitHub. If you want to play around, you can do the following:<br /><br /><ol><li><a href="http://golang.org/doc/install">Get Go 1.1</a>.</li><li><a href="http://llvm.org/releases/">Get Clang and LLVM</a> (I&rsquo;ve tested with 3.2, Ubuntu x86-64). Make sure llvm-config is in your $PATH.</li><li>Run &ldquo;go get github.com/axw/llgo/cmd/llgo-dist&rdquo;</li><li>Run &ldquo;llgo-dist&rdquo;. This will install llgo into $GOBIN, and build the runtime.</li></ol><div><br /></div><br />The biggest new feature would have to be: defer, panic and recover (I&rsquo;m lumping them together as they&rsquo;re closely related). I&rsquo;ve implemented them on top of <a href="http://llvm.org/docs/ExceptionHandling.html">LLVM&rsquo;s exception handling support</a>. The panic and recover functions are currently tied to DWARF exception handling, though it&rsquo;s simple enough that it should be feasible to use setjmp/longjmp on platforms where DWARF exception handling isn&rsquo;t viable.<br /><br />Aside from that, there&rsquo;s some new bits and bobs:<br /><br /><ul><li>Method sets are handled properly now (or at least not completely wrong like before). This means you can use a embedded types&rsquo; methods to satisfy an interface.</li><li>&ldquo;return&rdquo; requirements are now checked by go/types</li><li>cap() is now implemented for slices.</li><li>llgo-dist now builds against the LLVM static libraries (if available) by default now, with an option for building against the shared libraries.</li></ul><div><br /></div><div>I&rsquo;ll be working on a temporary fork of cmd/go to build programs with llgo, while a long-term solution is figured out. I&rsquo;d also like to get PNaCl integration working again, given that its release is nigh.</div><div><br /></div><div>That&rsquo;s all for now.</div><div><br /></div></p>

      </div>
      <h2 class="subtitle is-6">
      Posted May 18, 2013.
      
      </h2>
    </article>
    
    <article>
      <h1 class="title"><a href="https://awilkins.id.au/post/blogger/llgo-update-12/">llgo update #12</a></h1>
      <div class="content">
        <p>Oh my, it&rsquo;s been a while.<br /><br />In my <a href="http://blog.awilkins.id.au/2012/12/go-in-browser-llgo-does-pnacl.html">previous post</a>&nbsp;I wrote about llgo and PNaCl. I haven&rsquo;t had much time to play with PNaCl recently, but I have been prodding llgo along. In February, my wife gave birth to our son, Jeremy, so naturally I&rsquo;ve been busy. But anyway, let&rsquo;s talk about what has been happening in llgo. Quick, while he&rsquo;s sleeping!<br /><br />Feature-wise, there&rsquo;s nothing terribly exciting going on. Without getting too boring, what&rsquo;s new is:<br /><br /><ul><li>A new &ldquo;go1.1&rdquo; branch in the Git repository. The go1.1 branch aims to make llgo compatible with the Go tip, and will replace the master branch when Go 1.1 is released.</li><li>Removed llgo/types (a fork of the old exp/types package), and moved to go/types.</li><li>Updated runtime type representations to match those from gc&rsquo;s tip (thanks to minux for initiating this effort).</li><li>Updated to use architecture-specific size for &ldquo;int&rdquo; (same as uintptr).</li><li><a href="https://github.com/axw/llgo/commit/e26ff1f4a7ea661ff77b12a4cb7273f770d5a928">Changed function representation to be a pair of pointers</a>, to avoid trampolines/runtime code generation for closures. The rationale is the same as for rsc&rsquo;s proposal for Go 1.1; using runtime code generation limits the environments that Go can run in (e.g. PNaCl).</li><li>A slew of bug fixes and minor enhancements.</li></ul><div>The go/types change in particular was not a small one, but llgo came out much better at the end. As of the most recent go/types commits, llgo now passes all of its tests in the go1.1 branch. Now I can get back to implementing features again.</div><div><br /></div><div>That&rsquo;s about all there is to report. It has been <a href="https://github.com/axw/llgo/issues/26#issuecomment-13347764">suggested</a>&nbsp;that I set up some milestones in the GitHub project; I will spend a bit of time coming up with what I think are the bare essentials for a 0.1 release, and what would constitute future releases and so on.</div><div><br /></div><div>One last thing: there&rsquo;s a new(ish) <a href="https://groups.google.com/forum/?fromgroups#!forum/llgo-dev">llgo-dev</a> mailing list. If you want to get involved, or just lurk, come and join the party.</div><div><br /></div><div>Until next time.</div></p>

      </div>
      <h2 class="subtitle is-6">
      Posted March 1, 2013.
      
      </h2>
    </article>
    
  </div>
</section>

<section class="section">
  <div class="container">
    <nav class="level is-mobile">
      <div class="level-left">
        <div class="level-item">
          
          <a class="button is-disabled">
            <span class="icon is-small is-marginless">
              <i class="fa fa-angle-left"></i>
            </span>
            Newer
          </a>
          
        </div>
      </div>
      <div class="level-right is-marginless">
        <div class="level-item">
          
          <a class="button" href="/page/2/">
            Older
            <span class="icon is-small is-marginless">
              <i class="fa fa-angle-right"></i>
            </span>
          </a>
          
        </div>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container has-text-centered">
    <p></p>
  </div>
</section>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/python.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-17223840-3', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>



